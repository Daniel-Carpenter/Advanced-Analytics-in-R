---
title:    "ISE 5103 Intelligent Data Analytics"
subtitle: "Homework 6 - Modeling Competition"
author:   "Daniel Carpenter, Sonaxy Mohanty, & Zachary Knepp"
date:     "October 2022"
output: 
  pdf_document:
    toc: true
    toc_depth: 3
    highlight: arrow
    latex_engine: xelatex
  # github_document:
  #   toc: yes
  #   toc_depth: 2
urlcolor: blue
cache: true
fig.width: 7
fig.height: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\newpage

```{r echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
# Packages --------

# Data Wrangling
library(tidyverse)
library(skimr)
library(lubridate) # dates

# Modeling
library(MASS)
library(caret) # Modeling variants like SVM
library(earth) # Modeling with Mars
library(pls)   # Modeling with PLS
library(glmnet) # Modeling with LASSO

# Aesthetics
library(knitr)
library(cowplot)  # multiple ggplots on one plot with plot_grid()
library(scales)
library(kableExtra)
library(ggplot2)

#Hold-out Validation
library(caTools)

#Data Correlation
library(GGally)
library(regclass)

#RMSE Calculation
library(Metrics)

#p-value for OLS model
library(broom)

#ncvTest
library(car)
```

## General Data Prep
> For general data preparation, please see conceptual steps below. See `.rmd` file for detailed code.

### Read Training Data
Clean data to ensure each read variable has the correct data type (factor, numeric, Date, etc.)
```{r, echo=FALSE}
# Convert all character data to factor
df.train.base <- read.csv('Train.csv', stringsAsFactors = TRUE)

# convert the ""'s to NA
df.train.base[df.train.base == ""] <- NA

# Clean data
df.train.base <- df.train.base %>% 
  
  # Ensure boolean variables are numeric
  mutate(adwordsClickInfo.isVideoAd = as.numeric(adwordsClickInfo.isVideoAd) ) %>%
  
  # Make sure dates are dates
  mutate(date = as.Date(date),
         visitStartTime = as_datetime(visitStartTime)
         ) %>%

  # Ensure factor are factors
  mutate(custId       = as.factor(custId),
         sessionId    = as.factor(sessionId),
         isMobile     = as.factor(isMobile),
         isTrueDirect = as.factor(isTrueDirect),
         newVisits    = as.factor(if_else(is.na(newVisits), 0, 1) ),
         bounces      = as.factor(if_else(is.na(bounces),   0, 1)   ),
         adwordsClickInfo.page      = as.factor(adwordsClickInfo.page),
         adwordsClickInfo.isVideoAd = as.factor(adwordsClickInfo.isVideoAd)
         )
```

### Create `numeric` and `factor` `data frames`

Make data set of `numeric` variables called `df.train.base.numeric`
```{r, echo=FALSE}
df.train.base.numeric <- df.train.base %>%

  # selecting all the numeric data
  dplyr::select_if(is.numeric) %>%

  # converting the data frame to tibble
  as_tibble()
```

Make data set of `factor` variables called `df.train.base.factor`
```{r, echo=FALSE}
df.train.base.factor <- df.train.base %>%

  #selecting all the numeric data
  dplyr::select_if(is.factor) %>%

  #converting the data frame to tibble
  as_tibble()
```


## `2 (i)` - Data Understanding
> Create a data quality report of `numeric` and `factor` data

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Function for data report
dataQualityReport <- function(df) {
  
  # Function to remove any columns with NA
  removeColsWithNA <- function(df) {
    return( df[ , colSums(is.na(df)) == 0] )
  }
  
  # Create Comprehensive data report using skimr package
  # This is done a bit piece-wise because PDF latex does not like the skimr package
  # Very much. So Instead of printing `skim(df)`, I have to pull the contents manually
  # Unfortunately. This is not an issue with html typically.
  dataReport <- skim(df) %>%
    rename_all(~str_replace(.,"skim_","")) %>%
    arrange(type, desc(complete_rate) ) # sort data 
  
  # Filter to the class types
  dataReport.numeric <- dataReport %>% filter(type == 'numeric') # numeric data
  dataReport.factor  <- dataReport %>% filter(type == 'factor' ) # factor  data
  
  # Remove columns that do not apply to this type of data -----------------------
  
  ## numeric data
  dataReport.numeric <- removeColsWithNA(dataReport.numeric)  %>%
    
    # Clean column names by removing numeric prefix, 
    rename_all(~str_replace(.,"numeric.","")) 
    
  ## factor  data
  dataReport.factor  <- removeColsWithNA(dataReport.factor ) %>%
  
    # Clean column names by removing factor  prefix
    rename_all(~str_replace(.,"factor.",""))  
  
  
  # Set up options for Display the reports
  options(skimr_strip_metadata = FALSE)
  options(digits=2)
  options(scipen=99)
  
  # Numeric report <- Get summary of data frame --------------------------------
  
    # data frame stats
    dfStats.num <- data.frame(Num_Numeric_Variables = ncol(df %>% select_if(is.numeric)),
                              Total_Observations    = nrow(df) )
    
    # Now see individual column statistics
    dfColStats.num <- dataReport.numeric %>% 
      dplyr::select(-type, -hist)
    
  
  # Factor report <- Get summary of data frame --------------------------------
  
    # Get summary of data frame
    dfStats.factor <- data.frame(Num_Factor_Variables = ncol(df %>% select_if(is.factor)),
                                 Total_Observations   = nrow(df) )
    
    # Now see individual column statistics
    dfColStats.factor <- dataReport.factor  %>% 
      dplyr::select(-type, -ordered) 
    
    
  # Return the data frames
  return(list('dfStats.num'       = dfStats.num,    
              'dfColStats.num'    = dfColStats.num,
              'dfStats.factor'    = dfStats.factor, 
              'dfColStats.factor' = dfColStats.factor))
}
```

### Numeric Data Quality Report
* `pageviews` has some null values, but there are an insignificant amount, so we will just drop those rows.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Get the factor and numeric reports
initialReport <- dataQualityReport(df.train.base)

# Numeric data frame stats
initialReport$dfStats.num %>% kable()

# Numeric column stats
initialReport$dfColStats.num %>%
  kable() %>% kable_styling(font_size=7, latex_options = 'HOLD_position') # numeric data
```

\newpage

### Factor Data Quality Report
* Location data unknown, so add an `Unknown` label for `null` values
* Appears that few people use website from the ads, which cause many null values. See more details below.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# factor data frame stats
initialReport$dfStats.factor %>% kable()

# factor column stats
initialReport$dfColStats.factor %>%
  kable() %>% kable_styling(font_size=7, latex_options = 'HOLD_position') # numeric data
```


See that when `campaign` is `null`, then other `ad` related fields are (mostly) null  

* Implication: these other fields depend on the `campaign` variable

* So, set `adwordsClickInfo.page` null fields to `No Campaign` description, since a null value indicates
the user did not come using an advertisement  

```{r}
# look at non complete rows for ads 
adTest <- df.train.base.factor[!complete.cases(df.train.base.factor$campaign), ]

# Only look at ad columns where adwordsClickInfo.page is na
adTest <- adTest %>% dplyr::select(campaign, starts_with('ad'))

# See the percentage of missingness for each column where
# adwordsClickInfo.page has null values. Note nearly all null.
colSums(!is.na(adTest)) / nrow(adTest)

sum(!is.na(adTest)) / nrow(df.train.base)
rm(adTest)
```

```{r}
NO_CAMPAIGN_TEXT = 'No Campaign'

# Now clean up the data in the main data frame `df.train`
# by setting null values to "No Campaign" if there is no campaign.
# Applies to "ad*" and campaign variables
df.train <- df.train.base %>%
  mutate_at(
    # Only mutate the variables starting with ad, THEN the campaign variable
    vars(starts_with('ad'), campaign), 
    
    # Apply function rename set the campaign text if campaign is null
    list(~ as.factor(ifelse(is.na(campaign), NO_CAMPAIGN_TEXT, .) ) ) 
  ) 

# Check the data set - see that most of the ad data is now cleaned.
# report2 <- dataQualityReport(df.train)
# report2$dfColStats.factor %>% kable()
```



